#!/bin/bash

usage_func() {
    echo 
    echo "Usage: "`basename $0`" [Environment (preprod|prod)] [region] echo_only refresh_cache"
    echo 
    echo "example: " `basename $0` "preprod us-east-1"
    echo 
    exit 1
}

environment=$1
region=$2
echo_only=$3
refresh_cache=$4

if [ "$environment" = "" -o "$region" = "" ]; then
    usage_func
fi

. ~/bin/setenv.sh $environment

echo "Generating Inventory..."
if [ "$refresh_cache" = "Y" -o "$refresh_cache" = "y" ]; then
  ~/aws-ansible/bin/ec2.py --refresh-cache --list > ~/aws-ansible/inventory/$environment/hosts.gen
else
  ~/aws-ansible/bin/ec2.py --list > ~/aws-ansible/inventory/$environment/hosts.gen
fi
echo "Generating group_vars files..."
~/aws-ansible/bin/createGroupVars.pl $environment $region
rm -f ~/aws-ansible/inventory/$environment/hosts.gen


if [ "$environment" = "preprod" ]; then
  if [ "$region" = "us-east-1" ]; then
    limit='--limit 10.241.*'
  elif [ "$region" = "ec2" ]; then
    limit='--limit 10.241.*:10.244.*:10.248.*:10.252.*'
  fi
fi

while read key_name
do
  if [ "$echo_only" = "Y" -o "$echo_only" = "y" ]; then
    echo "ansible-playbook -i ~/aws-ansible/inventory/$environment/hosts $limit --extra-vars \"region=$region key_name=$key_name\" ~/aws-ansible/playbooks/check_bash_vulnerability.yml"
  else
    #ansible -i ~/aws-ansible/inventory/$environment/hosts $limit $region':&'key_$key_name':!platform_windows' -m check-bash -a "tag_name={{ec2_tag_Name}}"
    ansible-playbook -i ~/aws-ansible/inventory/$environment/hosts $limit --extra-vars "region=$region key_name=$key_name" ~/aws-ansible/playbooks/check_bash_vulnerability.yml -v
  fi
done < ~/aws-ansible/bin/$region'_keys.dat'

rm -f ~/aws-ansible/bin/$region'_keys.dat'
